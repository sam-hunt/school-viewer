import{j as e,n as k,d as M,b as f,F,o as z,p as T,E as A,M as i,h as D,H as W,f as H,m as _,q as G}from"./vendor-mui-DbcYjnqb.js";import{r as u,u as J}from"./vendor-react-Ri-ST5pw.js";import{u as N}from"./useSchoolList-CRB-QRJj.js";import{m as b}from"./mapbox-gl-VVs6Y5oX.js";import"./vendor-tanstack-Cjudyj3h.js";import"./vendor-mapbox-BgIuFgDP.js";const R=({lat:d,lng:m,zoom:c,width:v,height:j,features:a,onFeatureClick:p,clusterByProperty:s})=>{const[r,y]=u.useState(null),[h,C]=u.useState();return u.useEffect(()=>{if(!h)return;b.accessToken="pk.eyJ1Ijoic2FtLWh1bnQiLCJhIjoiY2trczR5bm11MHhmbDJwbnhnbmU0a2t3ciJ9.maCODbXshwiacsDdDCTy2g";const o=({setMap:t,mapContainerEl:E})=>{const n=new b.Map({container:E,style:"mapbox://styles/mapbox/dark-v10",center:[m,d],zoom:c});n.on("load",()=>{t(n),n.resize(),S(n)});const x=new b.NavigationControl;n.addControl(x,"top-right")},S=t=>{if(t&&a!==null){t.addSource("points",{type:"geojson",data:a,cluster:!0,clusterMaxZoom:14,clusterRadius:50,clusterProperties:{[s]:["+",["get",s]]}});const E=a?.features.map(l=>l.properties[s]).reduce((l,g)=>l+g,0),n=Math.log(E)-7,x=[10,20*n,15,50*n,25,125*n,30,250*n,35,500*n,40,750*n,45,1500*n,50];t.addLayer({id:"clusters",type:"circle",source:"points",filter:["has","point_count"],paint:{"circle-color":"#CB9EFF","circle-radius":["step",["get",s],...x]}}),t.addLayer({id:"cluster-count",type:"symbol",source:"points",filter:["has","point_count"],layout:{"text-field":`{${s?.toString()}}`,"text-font":["Arial Unicode MS Bold"],"text-size":14}}),t.addLayer({id:"unclustered-point",type:"circle",source:"points",filter:["!",["has","point_count"]],paint:{"circle-color":"#CB9EFF","circle-radius":["step",["get",s],...x],"circle-stroke-width":1,"circle-stroke-color":"#fff"}}),t.addLayer({id:"unclustered-count",type:"symbol",source:"points",filter:["!",["has","point_count"]],layout:{"text-field":`{${s?.toString()}}`,"text-font":["Arial Unicode MS Bold"],"text-size":14}}),t.on("click","clusters",function(l){const g=t.queryRenderedFeatures(l.point,{layers:["clusters"]}),L=g[0].properties.cluster_id;t.getSource("points").getClusterExpansionZoom(L,function(I,w){I||t.easeTo({center:g[0].geometry.coordinates,zoom:w})})}),p&&t.on("click","unclustered-point",l=>{p(l.features[0])}),t.on("mouseenter","clusters",()=>{t.getCanvas().style.cursor="pointer"}),t.on("mouseleave","clusters",()=>{t.getCanvas().style.cursor=""}),t.on("mouseenter","unclustered-point",()=>{t.getCanvas().style.cursor="pointer"}),t.on("mouseleave","unclustered-point",()=>{t.getCanvas().style.cursor=""})}};r&&(r.removeLayer("clusters"),r.removeLayer("cluster-count"),r.removeLayer("unclustered-point"),r.removeLayer("unclustered-count"),r.removeSource("points"),S(r)),r||o({setMap:y,mapContainerEl:h})},[r,d,m,c,a,p,s,h]),e.jsx("div",{className:"mapboxgl-container",ref:o=>C(o),style:{height:j,width:v}})},Q=()=>{const[d,m]=u.useState("count"),{data:c,error:v,isPending:j}=N(),[a,p]=u.useState(),s=J(),r=o=>s(`/schools/${o.properties.schoolId}`),y=u.useMemo(()=>({type:"FeatureCollection",features:(c||[]).filter(o=>o.lat&&o.lng).map(o=>({type:"Feature",geometry:{type:"Point",coordinates:[+o.lng,+o.lat]},properties:o}))}),[c]),h=`calc(${a?.clientHeight||"85vh"} - 50px)`,C=a?.clientWidth?a?.clientWidth:"95vw";return e.jsxs(k,{id:"home-section",component:"section",maxWidth:"xl",children:[e.jsxs(M,{direction:"row",alignItems:"center",my:3,gap:2,children:[e.jsx(f,{variant:"h4",component:"h1",flexGrow:"1",children:"NZ Schools Directory"}),e.jsxs(F,{children:[e.jsx(z,{id:"map-grouping-select-label",children:"Cluster Metric"}),e.jsxs(T,{labelId:"map-grouping-select-label",id:"map-grouping-select",value:d,label:"Cluster Metric",onChange:o=>m(o.target.value),IconComponent:A,sx:{width:250},size:"small",children:[e.jsx(i,{value:"count",children:"School Locations"}),e.jsx(i,{value:"maori",children:"MÄori Enrolments"}),e.jsx(i,{value:"pacific",children:"Pacific Enrolments"}),e.jsx(i,{value:"european",children:"European Enrolments"}),e.jsx(i,{value:"asian",children:"Asian Enrolments"}),e.jsx(i,{value:"melaa",children:"MELAA Enrolments"}),e.jsx(i,{value:"international",children:"International Enrolments"}),e.jsx(i,{value:"other",children:"Other Enrolments"}),e.jsx(i,{value:"total",children:"Total Enrolments"})]})]}),e.jsx(D,{title:e.jsx(f,{children:"Select a school or cluster for more information"}),enterDelay:0,children:e.jsx(W,{sx:{width:"28px",height:"28px",cursor:"help"}})})]}),c&&e.jsx(H,{ref:o=>p(o),children:e.jsx(R,{width:C,height:h,lat:-41,lng:173,zoom:5,features:y,onFeatureClick:r,clusterByProperty:d})}),j&&e.jsx(M,{height:"50vh",direction:"column",alignItems:"center",justifyContent:"center",children:e.jsx(_,{})}),v&&e.jsxs(M,{spacing:2,alignItems:"flex-start",children:[e.jsx(f,{variant:"h6",color:"error",children:"Unable to Load Map"}),e.jsx(f,{color:"text.secondary",children:"We're having trouble loading the schools data for the map. Please check your internet connection and try again."}),e.jsx(G,{variant:"contained",onClick:()=>window.location.reload(),children:"Try Again"})]})]})};export{Q as ClustersPage};
