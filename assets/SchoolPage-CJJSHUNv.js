import{j as e,s as p,b as c,D as S,t as C,v as E,w as z,x as r,y as t,B as b,o as w,z as L,J as T,d as u,u as A,n as M,K as g,r as m}from"./vendor-mui-CCOHixrn.js";import{r as v,k as _,u as I}from"./vendor-react-CSxt_BGh.js";import{u as P}from"./vendor-tanstack-DTWbCzqv.js";import{e as k,P as D}from"./vendor-nivo-CjYNyDxn.js";import{a as R,b as $}from"./maplibre-gl-BQVZoRRP.js";import{u as H}from"./useFocusOnNavigation-CxCOhBMX.js";import{u as N}from"./index-DGJYjs-j.js";const W="https://catalogue.data.govt.nz/api/3/action/datastore_search_sql",q="4b292323-9fcc-41f8-814b-3c7b19cf14b3",F="Unable to connect to the schools database. Please check your internet connection and try again.",G="The schools database is currently unavailable. Please try again later.",O=async a=>{if(!a)return null;const s=new URL(W),d=`
    SELECT
      "School_Id" as "schoolId",
      "Org_Name" as "orgName",
      "Org_Type" as "orgType",
      "Authority" as "authority",

      "Add1_City" as "add1City",
      "Add1_Suburb" as "add1Suburb",
      "Add1_Line1" as "add1Line1",

      "Add2_City" as "add2City",
      "Add2_Suburb" as "add2Suburb",
      "Add2_Line1" as "add2Line1",
      "Add2_Postal_Code" as "add2PostalCode",

      "Latitude" as "latitude",
      "Longitude" as "longitude",

      "Māori" as "maori",
      "Pacific" as "pacific",
      "European" as "european",
      "Asian" as "asian",
      "MELAA" as "melaa",
      "International" as "international",
      "Other" as "other",
      "Total" as "total",

      "Telephone" as "telephone",
      "Email" as "email",
      "URL" as "url",
      "Contact1_Name" as "contact1Name",

      "Education_Region" as "educationRegion",
      "General_Electorate" as "generalElectorate",
      "Māori_Electorate" as "maoriElectorate",

      "School_Donations" as "schoolDonations",
      "Isolation_Index" as "isolationIndex",
      "CoEd_Status" as "coEdStatus",
      "EQi_Index" as "eqiIndex",
      "Definition" as "definition",
      "Roll_Date" as "rollDate"
    FROM
      "${q}"
    WHERE
      "School_Id" = '${a}'
    `.trim().replace(/\s\s+/g," ");s.search=new URLSearchParams({sql:d}).toString();const l=await fetch(s.toString()).then(f=>f.json()).catch(()=>Promise.reject(new Error(F)));if(!l.success)throw new Error(G);const o=l.result.records;if(o.length===0)return null;const i=o[0];return{...i,maori:i.maori??0,pacific:i.pacific??0,european:i.european??0,asian:i.asian??0,melaa:i.melaa??0,international:i.international??0,other:i.other??0,total:i.total??0}},B=a=>{const{data:s,error:d,isPending:l}=P({queryKey:["school",a],queryFn:()=>O(a),enabled:!!a});return l?{isPending:!0,data:void 0,error:null}:d?{isPending:!1,data:void 0,error:d}:{isPending:!1,data:s,error:null}},U=({school:a})=>e.jsxs(p,{sx:{p:2},children:[e.jsx(c,{variant:"h5",component:"h2",mb:2,children:"Details"}),e.jsx(S,{sx:{mt:1}}),e.jsx(C,{children:e.jsx(E,{"aria-label":"School details and classification",sx:{border:0},children:e.jsxs(z,{children:[e.jsxs(r,{children:[e.jsx(t,{size:"small",component:"th",scope:"row",children:"Website"}),e.jsx(t,{size:"small",children:e.jsx("a",{href:a.url,target:"_blank",rel:"noopener noreferrer",children:a.url})})]}),e.jsxs(r,{children:[e.jsx(t,{size:"small",component:"th",scope:"row",children:"Organisation Type"}),e.jsx(t,{size:"small",children:a.orgType})]}),e.jsxs(r,{children:[e.jsx(t,{size:"small",component:"th",scope:"row",children:"Address 1"}),e.jsxs(t,{size:"small",children:[e.jsx(c,{children:a.add1Line1}),!!a.add1Suburb&&e.jsx(c,{children:a.add1Suburb}),e.jsx(c,{children:a.add1City})]})]}),e.jsxs(r,{children:[e.jsx(t,{size:"small",component:"th",scope:"row",children:"Address 2"}),e.jsxs(t,{size:"small",children:[e.jsxs(c,{children:[a.add2Line1,e.jsx("br",{})]}),e.jsxs(c,{children:[a.add2Suburb,a.add2Suburb&&e.jsx("br",{})]}),e.jsxs(c,{children:[a.add2City,e.jsx("br",{})]}),e.jsx(c,{children:a.add2PostalCode})]})]}),e.jsxs(r,{children:[e.jsx(t,{size:"small",component:"th",scope:"row",children:"Geolocation"}),e.jsxs(t,{size:"small",children:[a.latitude,", ",a.longitude]})]}),e.jsxs(r,{children:[e.jsx(t,{size:"small",component:"th",scope:"row",children:"Phone"}),e.jsx(t,{size:"small",children:e.jsx("a",{href:"tel:"+a.telephone.replace(/[.,\s\-_()]/g,""),children:a.telephone})})]}),e.jsxs(r,{sx:{"&:last-child td, &:last-child th":{border:0}},children:[e.jsx(t,{size:"small",component:"th",scope:"row",children:"Email"}),e.jsx(t,{size:"small",children:e.jsx("a",{href:"mailto:"+a.email,children:a.email})})]})]})})})]}),K=({school:a})=>e.jsxs(p,{sx:{p:2},children:[e.jsx(c,{variant:"h5",component:"h2",mb:2,children:"Miscellaneous"}),e.jsx(S,{sx:{mt:1}}),e.jsx(C,{children:e.jsx(E,{"aria-label":"Additional school information",children:e.jsxs(z,{children:[e.jsxs(r,{children:[e.jsx(t,{size:"small",component:"th",scope:"row",children:"Roll Date"}),e.jsx(t,{size:"small",children:a.rollDate})]}),e.jsxs(r,{children:[e.jsx(t,{size:"small",component:"th",scope:"row",children:"Equity Index"}),e.jsx(t,{size:"small",children:a.eqiIndex})]}),e.jsxs(r,{children:[e.jsx(t,{size:"small",component:"th",scope:"row",children:"Isolation Index"}),e.jsx(t,{size:"small",children:a.isolationIndex})]}),e.jsxs(r,{children:[e.jsx(t,{size:"small",component:"th",scope:"row",children:"CoEducation Status"}),e.jsx(t,{size:"small",children:a.coEdStatus})]}),e.jsxs(r,{children:[e.jsx(t,{size:"small",component:"th",scope:"row",children:"Education Region"}),e.jsx(t,{size:"small",children:a.educationRegion})]}),e.jsxs(r,{children:[e.jsx(t,{size:"small",component:"th",scope:"row",children:"General Electorate"}),e.jsx(t,{size:"small",children:a.generalElectorate})]}),e.jsxs(r,{children:[e.jsx(t,{size:"small",component:"th",scope:"row",children:"Māori Electorate"}),e.jsx(t,{size:"small",children:a.maoriElectorate})]}),e.jsxs(r,{children:[e.jsx(t,{size:"small",component:"th",scope:"row",children:"School Donations"}),e.jsx(t,{size:"small",children:a.schoolDonations})]}),e.jsxs(r,{children:[e.jsx(t,{size:"small",component:"th",scope:"row",children:"Authority"}),e.jsx(t,{size:"small",children:a.authority})]}),e.jsxs(r,{sx:{"&:last-child td, &:last-child th":{border:0}},children:[e.jsx(t,{size:"small",component:"th",scope:"row",children:"Definition"}),e.jsx(t,{size:"small",children:a.definition})]})]})})})]}),Q=({school:a})=>{const[s,d]=v.useState(),l=window.matchMedia("(prefers-reduced-motion: reduce)").matches,[o,i]=v.useState(l),[x,f]=v.useMemo(()=>{const n=s?.clientWidth??0,j=s?.clientHeight??0;return[n,j]},[s?.clientWidth,s?.clientHeight]),y=[{color:"#b2cefe",label:"Māori",value:a.maori,id:"Māori"},{color:"#fea3aa",label:"Pacific",value:a.pacific,id:"Pacific"},{color:"#cb9eff",label:"European",value:a.european,id:"European"},{color:"#baed91",label:"Asian",value:a.asian,id:"Asian"},{color:"#f8b88b",label:"MELAA",value:a.melaa,id:"MELAA"},{color:"#faf884",label:"International",value:a.international,id:"International"},{color:"#f2a2e8",label:"Other",value:a.other,id:"Other"}].filter(n=>n.value>0),h=a.total;return e.jsxs(p,{sx:{p:2},children:[e.jsxs(b,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(c,{variant:"h5",component:"h2",children:["Enrolments (",h,")"]}),h>0&&e.jsx(w,{onClick:()=>i(!o),startIcon:e.jsx(L,{}),variant:"outlined",size:"small","aria-expanded":o,"aria-controls":"enrolment-data-display",children:o?"Show Chart":"Show Data Table"})]}),o?e.jsxs(b,{sx:{mt:2},id:"enrolment-data-display",children:[e.jsx(c,{variant:"h6",component:"h3",gutterBottom:!0,children:"Enrolment Data Table"}),e.jsxs(E,{size:"small","aria-label":"Enrolment by ethnicity data table",children:[e.jsx(T,{children:e.jsxs(r,{children:[e.jsx(t,{component:"th",scope:"col",children:"Ethnicity"}),e.jsx(t,{component:"th",scope:"col",align:"right",children:"Students"}),e.jsx(t,{component:"th",scope:"col",align:"right",children:"Percentage"})]})}),e.jsxs(z,{children:[[...y].sort((n,j)=>j.value-n.value).map(n=>e.jsxs(r,{children:[e.jsx(t,{component:"th",scope:"row",children:e.jsxs(b,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(b,{sx:{width:12,height:12,backgroundColor:n.color,borderRadius:"2px"},"aria-hidden":"true"}),e.jsx("span",{lang:n.label==="Māori"?"mi":void 0,children:n.label})]})}),e.jsx(t,{align:"right",children:n.value}),e.jsxs(t,{align:"right",children:[(n.value/h*100).toFixed(1),"%"]})]},n.label)),e.jsxs(r,{sx:{fontWeight:"bold"},children:[e.jsx(t,{component:"th",scope:"row",children:"Total"}),e.jsx(t,{align:"right",children:h}),e.jsx(t,{align:"right",children:"100%"})]})]})]})]}):e.jsx(b,{ref:n=>d(n),sx:{minHeight:"450px",maxHeight:"600px"},px:2,py:0,role:"img","aria-label":`Enrolment by ethnicity for ${a.orgName}: ${y.map(n=>`${n.label} ${n.value.toString()} students`).join(", ")}`,id:"enrolment-data-display",children:h>0?window.innerWidth>640?e.jsx(k,{"data-testid":"pie-chart",width:x,height:f,isInteractive:!1,margin:{top:80,right:120,bottom:80,left:120},data:y,colors:{datum:"data.color"},startAngle:-90,innerRadius:.6,padAngle:.5,cornerRadius:5,enableArcLabels:!0,enableArcLinkLabels:!0,arcLabel:n=>{const j=Math.round(n.value/h*100);return j>2?`${j.toString()}%`:""},arcLinkLabel:n=>`${n.id.toString()}: ${n.value.toString()}`,arcLinkLabelsColor:{from:"color"},arcLinkLabelsThickness:3,arcLinkLabelsTextColor:{from:"color",modifiers:[["darker",1.2]]}}):e.jsx(D,{"data-testid":"bar-chart",layout:"horizontal",enableGridX:!1,enableGridY:!1,labelTextColor:"#fff",enableLabel:!0,width:s?.clientWidth??0,height:s?.clientHeight??0,data:y,colors:{datum:"data.color"},margin:{top:10,right:10,bottom:10,left:10}}):e.jsx(u,{height:f,justifyContent:"center",alignItems:"center",pb:5,children:e.jsx(c,{fontSize:"large",children:"No Enrolment Data"})})})]})},V=({lat:a,lng:s,zoom:d,width:l,height:o,ariaLabel:i})=>{const h=`https://api.maptiler.com/maps/${A().palette.mode==="dark"?"streets-v2-dark":"streets-v2-light"}/style.json?key=GqJ9q3X0Vl3cKDEQzKsu`;return e.jsx("div",{style:{height:o,width:l},children:e.jsx(R,{initialViewState:{longitude:s,latitude:a,zoom:d},style:{width:"100%",height:"100%"},mapStyle:h,interactive:!1,attributionControl:{compact:!1},"aria-label":i??`Map showing location at coordinates ${a.toFixed(4)}, ${s.toFixed(4)}`,children:e.jsx($,{longitude:s,latitude:a,color:"#CB9EFF"})})})},J=({school:a})=>{const[s,d]=v.useState(),[l,o]=v.useMemo(()=>{const i=s?.clientWidth??0,x=s?.clientHeight??0;return[i,x]},[s?.clientWidth,s?.clientHeight]);return e.jsx(b,{ref:i=>d(i),sx:{minHeight:"450px",maxHeight:"600px"},children:e.jsx(V,{width:l,height:o,lat:a.latitude,lng:a.longitude,zoom:6.5,ariaLabel:`Map showing the location of ${a.orgName}`})})},ne=()=>{const a=H(),{schoolId:s}=_(),d=I(),{data:l,error:o,isPending:i}=B(s),x=i?"Loading School...":o?"Unable to Load School":l?.orgName;return N(l?`${l.orgName} - Schools Viewer`:void 0),e.jsxs(M,{component:"section",maxWidth:"xl",children:[e.jsx(c,{variant:"h4",component:"h1",mt:3,mb:3,ref:a,tabIndex:-1,sx:{outline:"none"},children:x}),i&&e.jsxs(g,{container:!0,spacing:4,role:"status","aria-live":"polite","aria-label":"Loading school data",children:[e.jsx(g,{size:{md:6,xs:12},children:e.jsxs(u,{direction:"column",spacing:4,children:[e.jsxs(p,{sx:{p:2},children:[e.jsx(m,{variant:"text",width:"40%",height:40,sx:{mb:2}}),e.jsx(m,{variant:"rectangular",height:300})]}),e.jsx(p,{sx:{p:2},children:e.jsx(m,{variant:"rectangular",height:400})})]})}),e.jsx(g,{size:{md:6,xs:12},children:e.jsxs(u,{direction:"column",spacing:4,children:[e.jsxs(p,{sx:{p:2},children:[e.jsx(m,{variant:"text",width:"50%",height:40,sx:{mb:2}}),e.jsx(m,{variant:"rectangular",height:300})]}),e.jsxs(p,{sx:{p:2},children:[e.jsx(m,{variant:"text",width:"40%",height:40,sx:{mb:2}}),e.jsx(m,{variant:"rectangular",height:300})]})]})})]}),o&&e.jsxs(u,{spacing:2,alignItems:"flex-start",role:"alert",children:[e.jsx(c,{color:"text.secondary",children:"We're having trouble loading this school's information. This could be due to a network issue or the school may not exist in our database."}),e.jsxs(u,{direction:"row",spacing:2,children:[e.jsx(w,{variant:"contained",onClick:()=>window.location.reload(),children:"Try Again"}),e.jsx(w,{variant:"outlined",onClick:()=>void d("/schools"),children:"Browse All Schools"})]})]}),l&&e.jsxs(g,{container:!0,spacing:4,children:[e.jsx(g,{size:{md:6,xs:12},children:e.jsxs(u,{direction:"column",spacing:4,children:[e.jsx(U,{school:l}),e.jsx(J,{school:l})]})}),e.jsx(g,{size:{md:6,xs:12},children:e.jsxs(u,{direction:"column",spacing:4,sx:{height:"100%"},children:[e.jsx(Q,{school:l}),e.jsx(K,{school:l})]})})]})]})};export{ne as SchoolPage};
