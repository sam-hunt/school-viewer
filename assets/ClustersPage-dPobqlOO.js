import{u as R,j as o,n as A,d as k,b as S,h as K,H as U,g as O,F as q,p as Z,q as B,E as H,M as h,B as V,r as W,s as J,o as P}from"./vendor-mui-muqmfo5Z.js";import{r as c,u as Q}from"./vendor-react-CSxt_BGh.js";import{u as X}from"./useSchoolList-DQZos8bm.js";import{M as _,d as M,a as Y,N as ee}from"./maplibre-gl-DeZ9sfK4.js";import{u as te}from"./useFocusOnNavigation-CxCOhBMX.js";import{u as oe}from"./index-CFGUzlIS.js";import"./vendor-tanstack-Ig1BFDt_.js";function L(t,e){if(!t)throw new Error(e)}let ne=0;function ae(t,e,r){if(t.style&&t.style._loaded){const n={...r};return delete n.id,delete n.children,t.addSource(e,n),t.getSource(e)}return null}function se(t,e,r){L(e.id===r.id,"source id changed"),L(e.type===r.type,"source type changed");let n="",a=0;for(const i in e)i!=="children"&&i!=="id"&&!M(r[i],e[i])&&(n=i,a++);if(!a)return;const l=e.type;if(l==="geojson")t.setData(e.data);else if(l==="image")t.updateImage({url:e.url,coordinates:e.coordinates});else switch(n){case"coordinates":t.setCoordinates?.(e.coordinates);break;case"url":t.setUrl?.(e.url);break;case"tiles":t.setTiles?.(e.tiles);break;default:console.warn(`Unable to update <Source> prop: ${n}`)}}function re(t){const e=c.useContext(_).map.getMap(),r=c.useRef(t),[,n]=c.useState(0),a=c.useMemo(()=>t.id||`jsx-source-${ne++}`,[]);c.useEffect(()=>{if(e){const i=()=>setTimeout(()=>n(u=>u+1),0);return e.on("styledata",i),i(),()=>{if(e.off("styledata",i),e.style&&e.style._loaded&&e.getSource(a)){const u=e.getStyle()?.layers;if(u)for(const d of u)d.source===a&&e.removeLayer(d.id);e.removeSource(a)}}}},[e]);let l=e&&e.style&&e.getSource(a);return l?se(l,t,r.current):l=ae(e,a,t),r.current=t,l&&c.Children.map(t.children,i=>i&&c.cloneElement(i,{source:a}))||null}function ie(t,e,r,n){if(L(r.id===n.id,"layer id changed"),L(r.type===n.type,"layer type changed"),r.type==="custom"||n.type==="custom")return;const{layout:a={},paint:l={},filter:i,minzoom:u,maxzoom:d,beforeId:x}=r;if(x!==n.beforeId&&t.moveLayer(e,x),a!==n.layout){const f=n.layout||{};for(const s in a)M(a[s],f[s])||t.setLayoutProperty(e,s,a[s]);for(const s in f)a.hasOwnProperty(s)||t.setLayoutProperty(e,s,void 0)}if(l!==n.paint){const f=n.paint||{};for(const s in l)M(l[s],f[s])||t.setPaintProperty(e,s,l[s]);for(const s in f)l.hasOwnProperty(s)||t.setPaintProperty(e,s,void 0)}M(i,n.filter)||t.setFilter(e,i),(u!==n.minzoom||d!==n.maxzoom)&&t.setLayerZoomRange(e,u,d)}function le(t,e,r){if(t.style&&t.style._loaded&&(!("source"in r)||t.getSource(r.source))){const n={...r,id:e};delete n.beforeId,t.addLayer(n,r.beforeId)}}let ce=0;function C(t){const e=c.useContext(_).map.getMap(),r=c.useRef(t),[,n]=c.useState(0),a=c.useMemo(()=>t.id||`jsx-layer-${ce++}`,[]);if(c.useEffect(()=>{if(e){const i=()=>n(u=>u+1);return e.on("styledata",i),i(),()=>{e.off("styledata",i),e.style&&e.style._loaded&&e.getLayer(a)&&e.removeLayer(a)}}},[e]),e&&e.style&&e.getLayer(a))try{ie(e,a,t,r.current)}catch(i){console.warn(i)}else le(e,a,t);return r.current=t,null}const ue=({lat:t,lng:e,zoom:r,features:n,onFeatureClick:a,clusterByProperty:l})=>{const i=c.useRef(null),f=`https://api.maptiler.com/maps/${R().palette.mode==="dark"?"dataviz-dark":"dataviz-light"}/style.json?key=GqJ9q3X0Vl3cKDEQzKsu`,[s,p]=c.useState("grab"),[v,E]=c.useState(!1),z=n.features.reduce((j,m)=>{const g=m.properties;if(!g)return j;const b=g[l];return j+(typeof b=="number"?b:0)},0),y=Math.log(z)-7,w=[10,20*y,15,50*y,25,125*y,30,250*y,35,500*y,40,750*y,45,1500*y,50],T=c.useCallback(()=>{p("pointer")},[]),D=c.useCallback(()=>{p(v?"grabbing":"grab")},[v]),F=c.useCallback(()=>{E(!0),p("grabbing")},[]),N=c.useCallback(()=>{E(!1),p("grab")},[]),G=c.useCallback(j=>{const m=j.features?.[0];if(!m)return;const g=i.current;if(g)if(m.properties.cluster_id!==void 0){const b=m.properties.cluster_id,I=g.getSource("schools");if(!I)return;I.getClusterExpansionZoom(b).then($=>{m.geometry.type==="Point"&&g.easeTo({center:m.geometry.coordinates,zoom:$,duration:500})}).catch(()=>{})}else a&&a(m)},[a]);return o.jsxs(Y,{ref:i,initialViewState:{longitude:e,latitude:t,zoom:r},style:{width:"100%",height:"100%"},mapStyle:f,interactiveLayerIds:["clusters","unclustered-point"],onClick:G,onMouseEnter:T,onMouseLeave:D,onMouseDown:F,onMouseUp:N,cursor:s,children:[o.jsx(ee,{position:"top-right"}),o.jsxs(re,{id:"schools",type:"geojson",data:n,cluster:!0,clusterMaxZoom:14,clusterRadius:50,clusterProperties:{[l]:["+",["get",l]]},children:[o.jsx(C,{id:"clusters",type:"circle",filter:["has","point_count"],paint:{"circle-color":"#CB9EFF","circle-radius":["step",["get",l],...w]}}),o.jsx(C,{id:"cluster-count",type:"symbol",filter:["has","point_count"],layout:{"text-field":`{${l}}`,"text-font":["Noto Sans Regular"],"text-size":14}}),o.jsx(C,{id:"unclustered-point",type:"circle",filter:["!",["has","point_count"]],paint:{"circle-color":"#CB9EFF","circle-radius":["step",["get",l],...w],"circle-stroke-width":1,"circle-stroke-color":"#fff"}}),o.jsx(C,{id:"unclustered-count",type:"symbol",filter:["!",["has","point_count"]],layout:{"text-field":`{${l}}`,"text-font":["Noto Sans Regular"],"text-size":14}})]})]})},de="#141414",fe="#e0e0e1",be=()=>{const t=te(),e=R(),[r,n]=c.useState("count"),{data:a,error:l,isPending:i}=X(),u=Q();oe("School Clusters Map - Schools Viewer");const d=e.palette.mode==="dark"?de:fe,x=s=>void u(`/schools/${s.properties.schoolId}`),f=c.useMemo(()=>({type:"FeatureCollection",features:(a??[]).filter(s=>s.lat&&s.lng).map(s=>({type:"Feature",geometry:{type:"Point",coordinates:[s.lng,s.lat]},properties:s}))}),[a]);return o.jsxs(A,{id:"home-section",component:"section",maxWidth:"xl",children:[o.jsxs(k,{direction:{xs:"column",sm:"row"},alignItems:{xs:"stretch",sm:"center"},my:3,gap:2,children:[o.jsxs(k,{direction:"row",alignItems:"center",gap:1,flexGrow:"1",children:[o.jsx(S,{variant:"h4",component:"h1",ref:t,tabIndex:-1,sx:{outline:"none"},children:"NZ Schools Directory"}),o.jsx(K,{title:o.jsx(S,{children:"Select a school or cluster for more information"}),enterDelay:0,children:o.jsx(U,{sx:{width:"28px",height:"28px",cursor:"help",color:O[400]}})})]}),o.jsxs(q,{sx:{minWidth:{xs:"100%",sm:250}},children:[o.jsx(Z,{id:"map-grouping-select-label",children:"Cluster Metric"}),o.jsxs(B,{labelId:"map-grouping-select-label",id:"map-grouping-select",value:r,label:"Cluster Metric",onChange:s=>n(s.target.value),IconComponent:H,size:"small",children:[o.jsx(h,{value:"count",children:"School Locations"}),o.jsx(h,{value:"maori",children:"Māori Enrolments"}),o.jsx(h,{value:"pacific",children:"Pacific Enrolments"}),o.jsx(h,{value:"european",children:"European Enrolments"}),o.jsx(h,{value:"asian",children:"Asian Enrolments"}),o.jsx(h,{value:"melaa",children:"MELAA Enrolments"}),o.jsx(h,{value:"international",children:"International Enrolments"}),o.jsx(h,{value:"other",children:"Other Enrolments"}),o.jsx(h,{value:"total",children:"Total Enrolments"})]})]})]}),a&&o.jsx(V,{sx:{width:"100%",height:"calc(85vh - 50px)",borderRadius:1,overflow:"hidden",backgroundColor:d},children:o.jsx(ue,{lat:-41,lng:173,zoom:5,features:f,onFeatureClick:x,clusterByProperty:r})}),i&&o.jsx(W,{role:"status","aria-live":"polite","aria-label":"Loading school map data",sx:{width:"100%",height:"85vh",bgcolor:d},children:o.jsx(J,{variant:"rectangular",width:"100%",height:"100%",sx:{borderRadius:1,bgcolor:d},"data-testid":"skeleton-clusters-map"})}),l&&o.jsxs(k,{spacing:2,alignItems:"flex-start",role:"alert",children:[o.jsx(S,{variant:"h6",color:"error",children:"Unable to Load Map"}),o.jsx(S,{color:"text.secondary",children:"We're having trouble loading the schools data for the map. Please check your internet connection and try again."}),o.jsx(P,{variant:"contained",onClick:()=>window.location.reload(),children:"Try Again"})]})]})};export{be as ClustersPage};
