import{j as e,r as g,b as o,D as E,s as y,t as v,v as L,w as i,x as n,f as k,d as p,n as I,m as R,q as A,G as C}from"./vendor-mui-DbcYjnqb.js";import{r as d,k as D,u as W}from"./vendor-react-Ri-ST5pw.js";import{u as H}from"./vendor-tanstack-Cjudyj3h.js";import{e as N,P as $}from"./vendor-nivo-BVzXdi5n.js";import{m as b}from"./mapbox-gl-VVs6Y5oX.js";import"./vendor-mapbox-BgIuFgDP.js";const q="https://catalogue.data.govt.nz/api/3/action/datastore_search_sql",G="4b292323-9fcc-41f8-814b-3c7b19cf14b3",O=async s=>{if(!s)return null;const a=new URL(q),t=`
    SELECT
      "School_Id" as "schoolId",
      "Org_Name" as "orgName",
      "Org_Type" as "orgType",
      "Authority" as "authority",

      "Add1_City" as "add1City",
      "Add1_Suburb" as "add1Suburb",
      "Add1_Line1" as "add1Line1",

      "Add2_City" as "add2City",
      "Add2_Suburb" as "add2Suburb",
      "Add2_Line1" as "add2Line1",
      "Add2_Postal_Code" as "add2PostalCode",

      "Latitude" as "latitude",
      "Longitude" as "longitude",

      "Māori" as "maori",
      "Pacific" as "pacific",
      "European" as "european",
      "Asian" as "asian",
      "MELAA" as "melaa",
      "International" as "international",
      "Other" as "other",
      "Total" as "total",

      "Telephone" as "telephone",
      "Email" as "email",
      "URL" as "url",
      "Contact1_Name" as "contact1Name",

      "Education_Region" as "educationRegion",
      "General_Electorate" as "generalElectorate",
      "Māori_Electorate" as "maoriElectorate",

      "School_Donations" as "schoolDonations",
      "Isolation_Index" as "isolationIndex",
      "CoEd_Status" as "coEdStatus",
      "EQi_Index" as "eqiIndex",
      "Definition" as "definition",
      "Roll_Date" as "rollDate"
    FROM
      "${G}"
    WHERE
      "School_Id" = '${s}'
    `.trim().replace(/\s\s+/g," ");a.search=new URLSearchParams({sql:t}).toString();const r=await fetch(a.toString()).then(h=>h.json()).catch(()=>{throw new Error("Unable to connect to the schools database. Please check your internet connection and try again.")});if(!r.success)throw new Error("The schools database is currently unavailable. Please try again later.");return r.result.records[0]},U=s=>{const{data:a,error:t,isPending:r}=H({queryKey:["school",s],queryFn:()=>O(s),enabled:!!s});return r?{isPending:!0,data:void 0,error:null}:t?{isPending:!1,data:void 0,error:t}:{isPending:!1,data:a,error:null}},B=({school:s})=>e.jsxs(g,{sx:{p:2},children:[e.jsx(o,{variant:"h5",component:"h2",mb:2,children:"Details"}),e.jsx(E,{sx:{mt:1}}),e.jsx(y,{children:e.jsx(v,{"aria-label":"simple table",sx:{border:0},children:e.jsxs(L,{children:[e.jsxs(i,{children:[e.jsx(n,{size:"small",component:"th",scope:"row",children:"Organisation Type"}),e.jsx(n,{size:"small",children:s?.orgType})]}),e.jsxs(i,{children:[e.jsx(n,{size:"small",component:"th",scope:"row",children:"Address 1"}),e.jsxs(n,{size:"small",children:[e.jsx(o,{children:s?.add1Line1}),!!s?.add1Suburb&&e.jsx(o,{children:s?.add1Suburb}),e.jsx(o,{children:s?.add1City})]})]}),e.jsxs(i,{children:[e.jsx(n,{size:"small",component:"th",scope:"row",children:"Address 2"}),e.jsxs(n,{size:"small",children:[e.jsxs(o,{children:[s?.add2Line1,e.jsx("br",{})]}),e.jsxs(o,{children:[s?.add2Suburb,s?.add2Suburb&&e.jsx("br",{})]}),e.jsxs(o,{children:[s?.add2City,e.jsx("br",{})]}),e.jsx(o,{children:s?.add2PostalCode})]})]}),e.jsxs(i,{sx:{"&:last-child td, &:last-child th":{border:0}},children:[e.jsx(n,{size:"small",component:"th",scope:"row",children:"Geolocation"}),e.jsxs(n,{size:"small",children:[s?.latitude,", ",s?.longitude]})]})]})})})]}),J=({school:s})=>e.jsxs(g,{sx:{p:2},children:[e.jsx(o,{variant:"h5",component:"h2",mb:2,children:"Miscellaneous"}),e.jsx(E,{sx:{mt:1}}),e.jsx(y,{children:e.jsx(v,{"aria-label":"simple table",children:e.jsxs(L,{children:[e.jsxs(i,{children:[e.jsx(n,{size:"small",component:"th",scope:"row",children:"Definition"}),e.jsx(n,{size:"small",children:s?.definition})]}),e.jsxs(i,{children:[e.jsx(n,{size:"small",component:"th",scope:"row",children:"Roll Date"}),e.jsx(n,{size:"small",children:s?.rollDate})]}),e.jsxs(i,{children:[e.jsx(n,{size:"small",component:"th",scope:"row",children:"Equity Index"}),e.jsx(n,{size:"small",children:s?.eqiIndex})]}),e.jsxs(i,{children:[e.jsx(n,{size:"small",component:"th",scope:"row",children:"Isolation Index"}),e.jsx(n,{size:"small",children:s?.isolationIndex})]}),e.jsxs(i,{children:[e.jsx(n,{size:"small",component:"th",scope:"row",children:"CoEducation Status"}),e.jsx(n,{size:"small",children:s?.coEdStatus})]}),e.jsxs(i,{children:[e.jsx(n,{size:"small",component:"th",scope:"row",children:"Education Region"}),e.jsx(n,{size:"small",children:s?.educationRegion})]}),e.jsxs(i,{children:[e.jsx(n,{size:"small",component:"th",scope:"row",children:"General Electorate"}),e.jsx(n,{size:"small",children:s?.generalElectorate})]}),e.jsxs(i,{children:[e.jsx(n,{size:"small",component:"th",scope:"row",children:"Māori Electorate"}),e.jsx(n,{size:"small",children:s?.maoriElectorate})]}),e.jsxs(i,{children:[e.jsx(n,{size:"small",component:"th",scope:"row",children:"School Donations"}),e.jsx(n,{size:"small",children:s?.schoolDonations})]}),e.jsxs(i,{sx:{"&:last-child td, &:last-child th":{border:0}},children:[e.jsx(n,{size:"small",component:"th",scope:"row",children:"Authority"}),e.jsx(n,{size:"small",children:s?.authority})]})]})})})]}),Q=({school:s})=>e.jsxs(g,{sx:{p:2},children:[e.jsx(o,{variant:"h5",component:"h2",mb:2,children:"Contact"}),e.jsx(E,{sx:{mt:1}}),e.jsx(y,{children:e.jsx(v,{"aria-label":"simple table",children:e.jsxs(L,{children:[e.jsxs(i,{children:[e.jsx(n,{size:"small",component:"th",scope:"row",children:"Name"}),e.jsx(n,{size:"small",children:s?.contact1Name})]}),e.jsxs(i,{children:[e.jsx(n,{size:"small",component:"th",scope:"row",children:"Phone"}),e.jsx(n,{size:"small",children:e.jsx("a",{href:"tel:"+s?.telephone.replace(/[.,\s\-_()]/g,""),children:s?.telephone})})]}),e.jsxs(i,{children:[e.jsx(n,{size:"small",component:"th",scope:"row",children:"Email"}),e.jsx(n,{size:"small",children:e.jsx("a",{href:"mailto:"+s?.email,children:s?.email})})]}),e.jsxs(i,{children:[e.jsx(n,{size:"small",component:"th",scope:"row",children:"Web"}),e.jsx(n,{size:"small",children:e.jsx("a",{href:s?.url,children:s?.url})})]})]})})})]}),P=()=>{const[s,a]=d.useState({width:void 0,height:void 0});return d.useEffect(()=>{function t(){a({width:window.innerWidth,height:window.innerHeight})}return window.addEventListener("resize",t),t(),()=>window.removeEventListener("resize",t)},[]),s},F=({school:s})=>{const[a,t]=d.useState(),r=P(),[h,x]=d.useMemo(()=>{if(!r)return[0,0];const l=a?.clientWidth||0,j=a?.clientHeight||0;return[l,j]},[a?.clientWidth,a?.clientHeight,r]),c=[{color:"#b2cefe",label:"Māori",value:s?.maori||0,id:"Māori"},{color:"#fea3aa",label:"Pacific",value:s?.pacific||0,id:"Pacific"},{color:"#cb9eff",label:"European",value:s?.european||0,id:"European"},{color:"#baed91",label:"Asian",value:s?.asian||0,id:"Asian"},{color:"#f8b88b",label:"MELAA",value:s?.melaa||0,id:"MELAA"},{color:"#faf884",label:"International",value:s?.international||0,id:"International"},{color:"#f2a2e8",label:"Other",value:s?.other||0,id:"Other"}].filter(l=>l.value>0),u=s?.total??0;return e.jsxs(g,{sx:{p:2},children:[e.jsx(o,{variant:"h5",component:"h2",children:`Enrolments (${u})`}),e.jsx(k,{ref:l=>t(l),px:2,py:0,sx:{minHeight:"450px",maxHeight:"600px"},children:u>0?window.innerWidth>640?e.jsx(N,{width:h,height:x,isInteractive:!1,margin:{top:80,right:120,bottom:80,left:120},data:c,colors:{datum:"data.color"},startAngle:-90,innerRadius:.6,padAngle:.5,cornerRadius:5,enableArcLabels:!0,enableArcLinkLabels:!0,arcLabel:l=>{const j=Math.round(l.value/s?.total*100);return j>2?`${j}%`:""},arcLinkLabel:l=>`${l.id}: ${l.value}`,arcLinkLabelsColor:{from:"color"},arcLinkLabelsThickness:3,arcLinkLabelsTextColor:{from:"color",modifiers:[["darker",1.2]]}}):e.jsx($,{layout:"horizontal",enableGridX:!1,enableGridY:!1,labelTextColor:"#fff",enableLabel:!0,width:a?.clientWidth||0,height:a?.clientHeight||0,data:c,colors:{datum:"data.color"},margin:{top:10,right:10,bottom:10,left:10}}):e.jsx(p,{height:x,justifyContent:"center",alignItems:"center",pb:5,children:e.jsx(o,{fontSize:"large",children:"No Enrolment Data"})})})]})},Z=({lat:s,lng:a,zoom:t,width:r,height:h})=>{const x=d.useRef(null),[c,u]=d.useState(null),[l,j]=d.useState(null),[S,_]=d.useState("");return d.useEffect(()=>{b.accessToken="pk.eyJ1Ijoic2FtLWh1bnQiLCJhIjoiY2trczR5bm11MHhmbDJwbnhnbmU0a2t3ciJ9.maCODbXshwiacsDdDCTy2g";const f=({setMap:w,mapContainer:z})=>{const m=new b.Map({container:z.current,style:"mapbox://styles/mapbox/dark-v10",center:[a,s],zoom:t});m.on("load",()=>{w(m),m.resize(),M(m)}),m.dragPan.disable(),m.keyboard.disable(),m.scrollZoom.disable(),m.touchZoomRotate.disable(),m.doubleClickZoom.disable();const T=new b.NavigationControl;m.addControl(T,"top-right")},M=w=>{const z=new b.Marker().setLngLat([a,s]).addTo(w);j(z),_(`${s},${a}`)};c&&l&&S!==`${s},${a}`&&(l.remove(),M(c)),c||f({setMap:u,mapContainer:x})},[c,s,a,t,l,S]),e.jsx("div",{className:"mapboxgl-container",ref:f=>{x.current=f},style:{height:h,width:r}})},X=({school:s})=>{const[a,t]=d.useState(),r=P(),[h,x]=d.useMemo(()=>{if(!r)return[0,0];const c=a?.clientWidth||0,u=a?.clientHeight||0;return[c,u]},[a?.clientWidth,a?.clientHeight,r]);return e.jsx(k,{ref:c=>t(c),sx:{minHeight:"450px",maxHeight:"600px"},children:e.jsx(Z,{width:h,height:x,lat:s.latitude,lng:s.longitude,zoom:6.5})})},ae=()=>{const{schoolId:s}=D(),a=W(),{data:t,error:r,isPending:h}=U(s),x=h?"Loading School...":r?"Unable to Load School":t?.orgName;return e.jsxs(I,{component:"section",maxWidth:"xl",children:[e.jsx(o,{variant:"h4",component:"h1",mt:3,mb:3,children:x}),h&&e.jsx(p,{height:"50vh",direction:"column",alignItems:"center",justifyContent:"center",children:e.jsx(R,{})}),r&&e.jsxs(p,{spacing:2,alignItems:"flex-start",children:[e.jsx(o,{color:"text.secondary",children:"We're having trouble loading this school's information. This could be due to a network issue or the school may not exist in our database."}),e.jsxs(p,{direction:"row",spacing:2,children:[e.jsx(A,{variant:"contained",onClick:()=>window.location.reload(),children:"Try Again"}),e.jsx(A,{variant:"outlined",onClick:()=>a("/schools"),children:"Browse All Schools"})]})]}),t&&e.jsxs(C,{container:!0,spacing:4,children:[e.jsx(C,{size:{md:5,sm:12},children:e.jsxs(p,{direction:"column",spacing:4,children:[e.jsx(B,{school:t}),e.jsx(J,{school:t}),e.jsx(Q,{school:t})]})}),e.jsx(C,{size:{md:7,sm:12},children:e.jsxs(p,{direction:"column",spacing:4,children:[e.jsx(F,{school:t}),e.jsx(X,{school:t})]})})]})]})};export{ae as SchoolPage};
