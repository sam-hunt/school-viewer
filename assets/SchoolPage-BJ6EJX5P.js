import{j as e,r as x,b as l,D as v,t as w,v as b,w as f,x as i,y as s,B as j,o as g,z as S,J as C,d as u,u as y,n as L,K as p,s as m}from"./vendor-mui-muqmfo5Z.js";import{r as k,k as T}from"./vendor-react-CSxt_BGh.js";import{u as A}from"./vendor-tanstack-Ig1BFDt_.js";import{t as M}from"./vendor-nivo-Wq6pyRtl.js";import{a as _,b as I}from"./maplibre-gl-DeZ9sfK4.js";import{u as D}from"./useFocusOnNavigation-CxCOhBMX.js";import{u as R}from"./index-CFGUzlIS.js";const P="https://catalogue.data.govt.nz/api/3/action/datastore_search_sql",$="4b292323-9fcc-41f8-814b-3c7b19cf14b3",N="Unable to connect to the schools database. Please check your internet connection and try again.",B="The schools database is currently unavailable. Please try again later.",q=async a=>{if(!a)return null;const o=new URL(P),t=`
    SELECT
      "School_Id" as "schoolId",
      "Org_Name" as "orgName",
      "Org_Type" as "orgType",
      "Authority" as "authority",

      "Add1_City" as "add1City",
      "Add1_Suburb" as "add1Suburb",
      "Add1_Line1" as "add1Line1",

      "Add2_City" as "add2City",
      "Add2_Suburb" as "add2Suburb",
      "Add2_Line1" as "add2Line1",
      "Add2_Postal_Code" as "add2PostalCode",

      "Latitude" as "latitude",
      "Longitude" as "longitude",

      "Māori" as "maori",
      "Pacific" as "pacific",
      "European" as "european",
      "Asian" as "asian",
      "MELAA" as "melaa",
      "International" as "international",
      "Other" as "other",
      "Total" as "total",

      "Telephone" as "telephone",
      "Email" as "email",
      "URL" as "url",
      "Contact1_Name" as "contact1Name",

      "Education_Region" as "educationRegion",
      "General_Electorate" as "generalElectorate",
      "Māori_Electorate" as "maoriElectorate",

      "School_Donations" as "schoolDonations",
      "Isolation_Index" as "isolationIndex",
      "CoEd_Status" as "coEdStatus",
      "EQi_Index" as "eqiIndex",
      "Definition" as "definition",
      "Roll_Date" as "rollDate"
    FROM
      "${$}"
    WHERE
      "School_Id" = '${a}'
    `.trim().replace(/\s\s+/g," ");o.search=new URLSearchParams({sql:t}).toString();const c=await fetch(o.toString()).then(h=>h.json()).catch(()=>Promise.reject(new Error(N)));if(!c.success)throw new Error(B);const d=c.result.records;if(d.length===0)return null;const r=d[0];return{...r,maori:r.maori??0,pacific:r.pacific??0,european:r.european??0,asian:r.asian??0,melaa:r.melaa??0,international:r.international??0,other:r.other??0,total:r.total??0}},F=a=>{const{data:o,error:t,isPending:c}=A({queryKey:["school",a],queryFn:()=>q(a),enabled:!!a});return c?{isPending:!0,data:void 0,error:null}:t?{isPending:!1,data:void 0,error:t}:{isPending:!1,data:o,error:null}},O=({school:a})=>e.jsxs(x,{sx:{p:2},children:[e.jsx(l,{variant:"h5",component:"h2",mb:2,children:"Details"}),e.jsx(v,{sx:{mt:1}}),e.jsx(w,{children:e.jsx(b,{"aria-label":"School details and classification",sx:{border:0},children:e.jsxs(f,{children:[e.jsxs(i,{children:[e.jsx(s,{size:"small",component:"th",scope:"row",children:"Website"}),e.jsx(s,{size:"small",children:e.jsx("a",{href:a.url,target:"_blank",rel:"noopener noreferrer",children:a.url})})]}),e.jsxs(i,{children:[e.jsx(s,{size:"small",component:"th",scope:"row",children:"Organisation Type"}),e.jsx(s,{size:"small",children:a.orgType})]}),e.jsxs(i,{children:[e.jsx(s,{size:"small",component:"th",scope:"row",children:"Address 1"}),e.jsxs(s,{size:"small",children:[e.jsx(l,{children:a.add1Line1}),!!a.add1Suburb&&e.jsx(l,{children:a.add1Suburb}),e.jsx(l,{children:a.add1City})]})]}),e.jsxs(i,{children:[e.jsx(s,{size:"small",component:"th",scope:"row",children:"Address 2"}),e.jsxs(s,{size:"small",children:[e.jsxs(l,{children:[a.add2Line1,e.jsx("br",{})]}),e.jsxs(l,{children:[a.add2Suburb,a.add2Suburb&&e.jsx("br",{})]}),e.jsxs(l,{children:[a.add2City,e.jsx("br",{})]}),e.jsx(l,{children:a.add2PostalCode})]})]}),e.jsxs(i,{children:[e.jsx(s,{size:"small",component:"th",scope:"row",children:"Geolocation"}),e.jsxs(s,{size:"small",children:[a.latitude,", ",a.longitude]})]}),e.jsxs(i,{children:[e.jsx(s,{size:"small",component:"th",scope:"row",children:"Phone"}),e.jsx(s,{size:"small",children:e.jsx("a",{href:"tel:"+a.telephone.replace(/[.,\s\-_()]/g,""),children:a.telephone})})]}),e.jsxs(i,{sx:{"&:last-child td, &:last-child th":{border:0}},children:[e.jsx(s,{size:"small",component:"th",scope:"row",children:"Email"}),e.jsx(s,{size:"small",children:e.jsx("a",{href:"mailto:"+a.email,children:a.email})})]})]})})})]}),U=({school:a})=>e.jsxs(x,{sx:{p:2},children:[e.jsx(l,{variant:"h5",component:"h2",mb:2,children:"Miscellaneous"}),e.jsx(v,{sx:{mt:1}}),e.jsx(w,{children:e.jsx(b,{"aria-label":"Additional school information",children:e.jsxs(f,{children:[e.jsxs(i,{children:[e.jsx(s,{size:"small",component:"th",scope:"row",children:"Roll Date"}),e.jsx(s,{size:"small",children:a.rollDate})]}),e.jsxs(i,{children:[e.jsx(s,{size:"small",component:"th",scope:"row",children:"Equity Index"}),e.jsx(s,{size:"small",children:a.eqiIndex})]}),e.jsxs(i,{children:[e.jsx(s,{size:"small",component:"th",scope:"row",children:"Isolation Index"}),e.jsx(s,{size:"small",children:a.isolationIndex})]}),e.jsxs(i,{children:[e.jsx(s,{size:"small",component:"th",scope:"row",children:"CoEducation Status"}),e.jsx(s,{size:"small",children:a.coEdStatus})]}),e.jsxs(i,{children:[e.jsx(s,{size:"small",component:"th",scope:"row",children:"Education Region"}),e.jsx(s,{size:"small",children:a.educationRegion})]}),e.jsxs(i,{children:[e.jsx(s,{size:"small",component:"th",scope:"row",children:"General Electorate"}),e.jsx(s,{size:"small",children:a.generalElectorate})]}),e.jsxs(i,{children:[e.jsx(s,{size:"small",component:"th",scope:"row",children:"Māori Electorate"}),e.jsx(s,{size:"small",children:a.maoriElectorate})]}),e.jsxs(i,{children:[e.jsx(s,{size:"small",component:"th",scope:"row",children:"School Donations"}),e.jsx(s,{size:"small",children:a.schoolDonations})]}),e.jsxs(i,{children:[e.jsx(s,{size:"small",component:"th",scope:"row",children:"Authority"}),e.jsx(s,{size:"small",children:a.authority})]}),e.jsxs(i,{sx:{"&:last-child td, &:last-child th":{border:0}},children:[e.jsx(s,{size:"small",component:"th",scope:"row",children:"Definition"}),e.jsx(s,{size:"small",children:a.definition})]})]})})})]}),G=({school:a})=>{const o=window.matchMedia("(prefers-reduced-motion: reduce)").matches,[t,c]=k.useState(o),d=[{color:"#b2cefe",label:"Māori",value:a.maori,id:"Māori"},{color:"#fea3aa",label:"Pacific",value:a.pacific,id:"Pacific"},{color:"#cb9eff",label:"European",value:a.european,id:"European"},{color:"#baed91",label:"Asian",value:a.asian,id:"Asian"},{color:"#f8b88b",label:"MELAA",value:a.melaa,id:"MELAA"},{color:"#faf884",label:"International",value:a.international,id:"International"},{color:"#f2a2e8",label:"Other",value:a.other,id:"Other"}].filter(n=>n.value>0),r=a.total;return e.jsxs(x,{children:[e.jsxs(j,{sx:{p:2,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(l,{variant:"h5",component:"h2",children:["Enrolments (",r,")"]}),r>0&&e.jsx(g,{onClick:()=>c(!t),startIcon:e.jsx(S,{}),variant:"outlined",size:"small","aria-expanded":t,"aria-controls":"enrolment-data-display",children:t?"Show Chart":"Show Data Table"})]}),t?e.jsxs(j,{sx:{p:2},id:"enrolment-data-display",children:[e.jsx(l,{variant:"h6",component:"h3",gutterBottom:!0,children:"Enrolment Data Table"}),e.jsxs(b,{size:"small","aria-label":"Enrolment by ethnicity data table",children:[e.jsx(C,{children:e.jsxs(i,{children:[e.jsx(s,{component:"th",scope:"col",children:"Ethnicity"}),e.jsx(s,{component:"th",scope:"col",align:"right",children:"Students"}),e.jsx(s,{component:"th",scope:"col",align:"right",children:"Percentage"})]})}),e.jsxs(f,{children:[[...d].sort((n,h)=>h.value-n.value).map(n=>e.jsxs(i,{children:[e.jsx(s,{component:"th",scope:"row",children:e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(j,{sx:{width:12,height:12,backgroundColor:n.color,borderRadius:"2px"},"aria-hidden":"true"}),e.jsx("span",{lang:n.label==="Māori"?"mi":void 0,children:n.label})]})}),e.jsx(s,{align:"right",children:n.value}),e.jsxs(s,{align:"right",children:[(n.value/r*100).toFixed(1),"%"]})]},n.label)),e.jsxs(i,{sx:{fontWeight:"bold"},children:[e.jsx(s,{component:"th",scope:"row",children:"Total"}),e.jsx(s,{align:"right",children:r}),e.jsx(s,{align:"right",children:"100%"})]})]})]})]}):e.jsx(j,{sx:{height:"500px",width:"100%"},role:"img","aria-label":`Enrolment by ethnicity for ${a.orgName}: ${d.map(n=>`${n.label} ${n.value.toString()} students`).join(", ")}`,id:"enrolment-data-display",children:r>0?e.jsx(M,{"data-testid":"pie-chart",isInteractive:!1,margin:{top:80,right:120,bottom:80,left:120},data:d,colors:{datum:"data.color"},startAngle:-90,innerRadius:.6,padAngle:.5,cornerRadius:5,enableArcLabels:!0,enableArcLinkLabels:!0,arcLabel:n=>{const h=Math.round(n.value/r*100);return h>2?`${h.toString()}%`:""},arcLinkLabel:n=>`${n.id.toString()}: ${n.value.toString()}`,arcLinkLabelsColor:{from:"color"},arcLinkLabelsThickness:3,arcLinkLabelsTextColor:{from:"color",modifiers:[["darker",1.2]]}}):e.jsx(u,{height:"100%",justifyContent:"center",alignItems:"center",pb:5,children:e.jsx(l,{fontSize:"large",children:"No Enrolment Data"})})})]})},K=({lat:a,lng:o,zoom:t,ariaLabel:c})=>{const h=`https://api.maptiler.com/maps/${y().palette.mode==="dark"?"streets-v2-dark":"streets-v2-light"}/style.json?key=GqJ9q3X0Vl3cKDEQzKsu`;return e.jsx(_,{initialViewState:{longitude:o,latitude:a,zoom:t},style:{width:"100%",height:"100%"},mapStyle:h,interactive:!1,attributionControl:{compact:!1},"aria-label":c??`Map showing location at coordinates ${a.toFixed(4)}, ${o.toFixed(4)}`,children:e.jsx(I,{longitude:o,latitude:a,color:"#CB9EFF"})})},z="#172130",E="#dedede",W=({school:a})=>{const t=y().palette.mode==="dark"?z:E;return e.jsx(x,{children:e.jsx(j,{sx:{height:"500px",width:"100%",overflow:"hidden",borderRadius:1,bgcolor:t},children:e.jsx(K,{lat:a.latitude,lng:a.longitude,zoom:6.5,ariaLabel:`Map showing the location of ${a.orgName}`})})})},ee=()=>{const a=D(),{schoolId:o}=T(),{data:t,error:c,isPending:d}=F(o),r=d?"Loading School...":c?"Unable to Load School":t?.orgName,h=y().palette.mode==="dark"?z:E;return R(t?`${t.orgName} - Schools Viewer`:void 0),e.jsxs(L,{component:"section",maxWidth:"xl",children:[e.jsx(l,{variant:"h4",component:"h1",mt:3,mb:3,ref:a,tabIndex:-1,sx:{outline:"none"},children:r}),d&&e.jsxs(p,{container:!0,spacing:4,role:"status","aria-live":"polite","aria-label":"Loading school data",children:[e.jsx(p,{size:{md:6,xs:12},children:e.jsxs(u,{direction:"column",spacing:4,children:[e.jsxs(x,{sx:{p:2},children:[e.jsx(m,{"data-testid":"skeleton-details-card-heading",variant:"text",width:"40%",height:40,sx:{mb:2}}),e.jsx(m,{"data-testid":"skeleton-details-card-content",variant:"rectangular",height:300})]}),e.jsx(x,{children:e.jsx(m,{"data-testid":"skeleton-map-card",variant:"rectangular",height:500,sx:{bgcolor:h}})})]})}),e.jsx(p,{size:{md:6,xs:12},children:e.jsxs(u,{direction:"column",spacing:4,children:[e.jsxs(x,{sx:{p:2},children:[e.jsx(m,{"data-testid":"skeleton-enrolments-card-heading",variant:"text",width:"50%",height:40,sx:{mb:2}}),e.jsx(m,{"data-testid":"skeleton-enrolments-card-content",variant:"rectangular",height:450})]}),e.jsxs(x,{sx:{p:2},children:[e.jsx(m,{"data-testid":"skeleton-misc-card-heading",variant:"text",width:"40%",height:40,sx:{mb:2}}),e.jsx(m,{"data-testid":"skeleton-misc-card-content",variant:"rectangular",height:350})]})]})})]}),c&&e.jsxs(u,{spacing:2,alignItems:"flex-start",role:"alert",children:[e.jsx(l,{color:"text.secondary",children:"We're having trouble loading this school's information. This could be due to a network issue or the school may not exist in our database."}),e.jsxs(u,{direction:"row",spacing:2,children:[e.jsx(g,{variant:"contained",onClick:()=>window.location.reload(),children:"Try Again"}),e.jsx(g,{variant:"outlined",href:"/schools",children:"Browse All Schools"})]})]}),t&&e.jsxs(p,{container:!0,spacing:4,children:[e.jsx(p,{size:{md:6,xs:12},children:e.jsxs(u,{direction:"column",spacing:4,children:[e.jsx(O,{school:t}),e.jsx(W,{school:t})]})}),e.jsx(p,{size:{md:6,xs:12},children:e.jsxs(u,{direction:"column",spacing:4,sx:{height:"100%"},children:[e.jsx(G,{school:t}),e.jsx(U,{school:t})]})})]})]})};export{ee as SchoolPage};
