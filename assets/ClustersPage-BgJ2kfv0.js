import{u as H,j as n,n as O,d as z,b as C,F as W,p as q,q as A,E as Z,M as h,h as V,H as J,B as T,r as Q,o as X}from"./vendor-mui-CCOHixrn.js";import{r as i,u as B}from"./vendor-react-CSxt_BGh.js";import{u as Y}from"./useSchoolList-CX6H3ZNN.js";import{M as $,d as v,a as P,N as ee}from"./maplibre-gl-DSjoHQqT.js";import{u as te}from"./useFocusOnNavigation-CxCOhBMX.js";import{u as ne}from"./index-BAqkaTXI.js";import"./vendor-tanstack-DTWbCzqv.js";function E(t,e){if(!t)throw new Error(e)}let oe=0;function ae(t,e,s){if(t.style&&t.style._loaded){const o={...s};return delete o.id,delete o.children,t.addSource(e,o),t.getSource(e)}return null}function se(t,e,s){E(e.id===s.id,"source id changed"),E(e.type===s.type,"source type changed");let o="",r=0;for(const a in e)a!=="children"&&a!=="id"&&!v(s[a],e[a])&&(o=a,r++);if(!r)return;const l=e.type;if(l==="geojson")t.setData(e.data);else if(l==="image")t.updateImage({url:e.url,coordinates:e.coordinates});else switch(o){case"coordinates":t.setCoordinates?.(e.coordinates);break;case"url":t.setUrl?.(e.url);break;case"tiles":t.setTiles?.(e.tiles);break;default:console.warn(`Unable to update <Source> prop: ${o}`)}}function re(t){const e=i.useContext($).map.getMap(),s=i.useRef(t),[,o]=i.useState(0),r=i.useMemo(()=>t.id||`jsx-source-${oe++}`,[]);i.useEffect(()=>{if(e){const a=()=>setTimeout(()=>o(c=>c+1),0);return e.on("styledata",a),a(),()=>{if(e.off("styledata",a),e.style&&e.style._loaded&&e.getSource(r)){const c=e.getStyle()?.layers;if(c)for(const f of c)f.source===r&&e.removeLayer(f.id);e.removeSource(r)}}}},[e]);let l=e&&e.style&&e.getSource(r);return l?se(l,t,s.current):l=ae(e,r,t),s.current=t,l&&i.Children.map(t.children,a=>a&&i.cloneElement(a,{source:r}))||null}function ie(t,e,s,o){if(E(s.id===o.id,"layer id changed"),E(s.type===o.type,"layer type changed"),s.type==="custom"||o.type==="custom")return;const{layout:r={},paint:l={},filter:a,minzoom:c,maxzoom:f,beforeId:p}=s;if(p!==o.beforeId&&t.moveLayer(e,p),r!==o.layout){const y=o.layout||{};for(const u in r)v(r[u],y[u])||t.setLayoutProperty(e,u,r[u]);for(const u in y)r.hasOwnProperty(u)||t.setLayoutProperty(e,u,void 0)}if(l!==o.paint){const y=o.paint||{};for(const u in l)v(l[u],y[u])||t.setPaintProperty(e,u,l[u]);for(const u in y)l.hasOwnProperty(u)||t.setPaintProperty(e,u,void 0)}v(a,o.filter)||t.setFilter(e,a),(c!==o.minzoom||f!==o.maxzoom)&&t.setLayerZoomRange(e,c,f)}function le(t,e,s){if(t.style&&t.style._loaded&&(!("source"in s)||t.getSource(s.source))){const o={...s,id:e};delete o.beforeId,t.addLayer(o,s.beforeId)}}let ce=0;function M(t){const e=i.useContext($).map.getMap(),s=i.useRef(t),[,o]=i.useState(0),r=i.useMemo(()=>t.id||`jsx-layer-${ce++}`,[]);if(i.useEffect(()=>{if(e){const a=()=>o(c=>c+1);return e.on("styledata",a),a(),()=>{e.off("styledata",a),e.style&&e.style._loaded&&e.getLayer(r)&&e.removeLayer(r)}}},[e]),e&&e.style&&e.getLayer(r))try{ie(e,r,t,s.current)}catch(a){console.warn(a)}else le(e,r,t);return s.current=t,null}const ue=({lat:t,lng:e,zoom:s,width:o,height:r,features:l,onFeatureClick:a,clusterByProperty:c})=>{const f=i.useRef(null),L=`https://api.maptiler.com/maps/${H().palette.mode==="dark"?"streets-v2-dark":"streets-v2-light"}/style.json?key=GqJ9q3X0Vl3cKDEQzKsu`,[d,j]=i.useState("grab"),[k,w]=i.useState(!1),_=l.features.reduce((S,m)=>{const x=m.properties;if(!x)return S;const b=x[c];return S+(typeof b=="number"?b:0)},0),g=Math.log(_)-7,I=[10,20*g,15,50*g,25,125*g,30,250*g,35,500*g,40,750*g,45,1500*g,50],D=i.useCallback(()=>{j("pointer")},[]),F=i.useCallback(()=>{j(k?"grabbing":"grab")},[k]),N=i.useCallback(()=>{w(!0),j("grabbing")},[]),U=i.useCallback(()=>{w(!1),j("grab")},[]),K=i.useCallback(S=>{const m=S.features?.[0];if(!m)return;const x=f.current;if(x)if(m.properties.cluster_id!==void 0){const b=m.properties.cluster_id,R=x.getSource("schools");if(!R)return;R.getClusterExpansionZoom(b).then(G=>{m.geometry.type==="Point"&&x.easeTo({center:m.geometry.coordinates,zoom:G,duration:500})}).catch(()=>{})}else a&&a(m)},[a]);return n.jsx("div",{style:{height:r,width:o},children:n.jsxs(P,{ref:f,initialViewState:{longitude:e,latitude:t,zoom:s},style:{width:"100%",height:"100%"},mapStyle:L,interactiveLayerIds:["clusters","unclustered-point"],onClick:K,onMouseEnter:D,onMouseLeave:F,onMouseDown:N,onMouseUp:U,cursor:d,children:[n.jsx(ee,{position:"top-right"}),n.jsxs(re,{id:"schools",type:"geojson",data:l,cluster:!0,clusterMaxZoom:14,clusterRadius:50,clusterProperties:{[c]:["+",["get",c]]},children:[n.jsx(M,{id:"clusters",type:"circle",filter:["has","point_count"],paint:{"circle-color":"#CB9EFF","circle-radius":["step",["get",c],...I]}}),n.jsx(M,{id:"cluster-count",type:"symbol",filter:["has","point_count"],layout:{"text-field":`{${c}}`,"text-font":["Noto Sans Regular"],"text-size":14}}),n.jsx(M,{id:"unclustered-point",type:"circle",filter:["!",["has","point_count"]],paint:{"circle-color":"#CB9EFF","circle-radius":["step",["get",c],...I],"circle-stroke-width":1,"circle-stroke-color":"#fff"}}),n.jsx(M,{id:"unclustered-count",type:"symbol",filter:["!",["has","point_count"]],layout:{"text-field":`{${c}}`,"text-font":["Noto Sans Regular"],"text-size":14}})]})]})})},pe=()=>{const t=te(),[e,s]=i.useState("count"),{data:o,error:r,isPending:l}=Y(),[a,c]=i.useState(),f=B();ne("School Clusters Map - Schools Viewer");const p=d=>void f(`/schools/${d.properties.schoolId}`),y=i.useMemo(()=>({type:"FeatureCollection",features:(o??[]).filter(d=>d.lat&&d.lng).map(d=>({type:"Feature",geometry:{type:"Point",coordinates:[d.lng,d.lat]},properties:d}))}),[o]),u=`calc(${a?.clientHeight?`${a.clientHeight.toString()}px`:"85vh"} - 50px)`,L=a?.clientWidth?`${a.clientWidth.toString()}px`:"95vw";return n.jsxs(O,{id:"home-section",component:"section",maxWidth:"xl",children:[n.jsxs(z,{direction:"row",alignItems:"center",my:3,gap:2,children:[n.jsx(C,{variant:"h4",component:"h1",flexGrow:"1",ref:t,tabIndex:-1,sx:{outline:"none"},children:"NZ Schools Directory"}),n.jsxs(W,{children:[n.jsx(q,{id:"map-grouping-select-label",children:"Cluster Metric"}),n.jsxs(A,{labelId:"map-grouping-select-label",id:"map-grouping-select",value:e,label:"Cluster Metric",onChange:d=>s(d.target.value),IconComponent:Z,sx:{width:250},size:"small",children:[n.jsx(h,{value:"count",children:"School Locations"}),n.jsx(h,{value:"maori",children:"Māori Enrolments"}),n.jsx(h,{value:"pacific",children:"Pacific Enrolments"}),n.jsx(h,{value:"european",children:"European Enrolments"}),n.jsx(h,{value:"asian",children:"Asian Enrolments"}),n.jsx(h,{value:"melaa",children:"MELAA Enrolments"}),n.jsx(h,{value:"international",children:"International Enrolments"}),n.jsx(h,{value:"other",children:"Other Enrolments"}),n.jsx(h,{value:"total",children:"Total Enrolments"})]})]}),n.jsx(V,{title:n.jsx(C,{children:"Select a school or cluster for more information"}),enterDelay:0,children:n.jsx(J,{sx:{width:"28px",height:"28px",cursor:"help"}})})]}),o&&n.jsx(T,{ref:d=>c(d),children:n.jsx(ue,{width:L,height:u,lat:-41,lng:173,zoom:5,features:y,onFeatureClick:p,clusterByProperty:e})}),l&&n.jsx(T,{role:"status","aria-live":"polite","aria-label":"Loading school map data",sx:{width:"100%",height:"85vh"},children:n.jsx(Q,{variant:"rectangular",width:"100%",height:"100%",sx:{borderRadius:1}})}),r&&n.jsxs(z,{spacing:2,alignItems:"flex-start",role:"alert",children:[n.jsx(C,{variant:"h6",color:"error",children:"Unable to Load Map"}),n.jsx(C,{color:"text.secondary",children:"We're having trouble loading the schools data for the map. Please check your internet connection and try again."}),n.jsx(X,{variant:"contained",onClick:()=>window.location.reload(),children:"Try Again"})]})]})};export{pe as ClustersPage};
